# Setting up NUS Bus API in Xcode

## Getting Started

The simulator can be run directly from Xcode when all the files are copied over.

Here is what each file in each folder does:

- Models
  - `ActiveBus.swift`: model to parse the active bus routes response from the API
  - `ArrivalInfo.swift`: model to parse bus arrival response from API
  - `BusRoute.swift`: contains a hardcoded set of NUS bus route codes
    - Generated by appending the request `/ServiceDescription` to the end of [the URL](https://nnextbus.nus.edu.sg) (more on how to use the API below)
    - Each bus route code corresponds to the "Route" section of the JSON response
  - `BusStop.swift`: model to parse NUSBusStop.json
- Resources
  - `NUSBusStops.json`: the JSON response from the API of the list of bus stops
    - Append the request `/BusStops`to the end of [the URL](https://nnextbus.nus.edu.sg) (more on how to use the API below)
    - Bus stop names required to use the `/ShuttleService` request for the API corresponds to the "name" section of this JSON response
- Services
  - `NUSNextBusService.swift` contains functions to authenticate and query the API with
- Utilities
  - `NetworkConstants.swift` stores the baseURL, username and password
- ViewModels
  - `ActivebusViewModel.swift`: uses the `NUSNextBusService.swift` to authenticate and request for active bus routes (using data from `BusRoute.swift`, according to bus routes selected by user through `ActiveBusTestView.swift`)
  - `BusArrivalViewModel.swift`: uses the `NUSNextBusService.swift` to authenticate and request for bus arrival timings (using data from `NUSBusStops.json`, according to bus stops selected by user through `BusArrivalTestView.swift`)
- Views
  - `ActiveBusTestView.swift` is purely to test that the /ActiveBus query works on the app, so we can check which bus routes are active
  - `BusArrivalTestView.swift` is an example of how selection can be done for UI

# How the NUS Bus API works

The API runs on https and requires basic access authentication though a popup on the page.

## Prerequisites

Follow instructions from [here](https://suibianp.github.io/nus-nextbus-new-api/)

- Gives the format of JSON responses in all possible cases
- Can try the queries here, including others not touched on in this md. JSON responses include:
  - Real time info according to format provided
  - The https link used

## Base URL

https://nnextbus.nus.edu.sg

## Authentication

Username and password for authentication can be retrieved from this GitHub repository: [NUS NextBus New API](https://github.com/SuibianP/nus-nextbus-new-api).

## Endpoints

Targetted these 2 endpoints among others

1. Bus Arrival Timing

### Request

Append `/ShuttleService?busstopname=<name>` to the end of the base URL.

#### Sample Request

https://nnextbus.nus.edu.sg/ShuttleService?busstopname=COM3

### Sample Response

Showing data for only 1 service as sample.

```
{
    "ShuttleServiceResult": {
        "TimeStamp": "2025-06-12T16:35:56+08:00",
        "hints": [
            "[D1:201424]PD533T: Normal-Shuttle: passed stop COM 3 (S)",
        ],
        "name": "COM3",
        "shuttles": [
            {
                "passengers": "-",
                "name": "D1",
                "_etas": [
                    {
                        "plate": "PD776J",
                        "px": "-",
                        "ts": "2025-06-12 16:18:00",
                        "jobid": 17411493,
                        "eta": 0,
                        "eta_s": 4
                    },
                ],
                "nextArrivalTime": "14",
                "routeid": 90294,
                "busstopcode": "COM3-D1-E",
                "arrivalTime_veh_plate": "PD776J",
                "arrivalTime": "Arr",
                "nextPassengers": "-",
                "nextArrivalTime_veh_plate": "PD533T"
            },
        ],
        "caption": "COM 3"
    }
}
```

2. Active Bus Lines

### Request

Append `/ActiveBus?route_code=<RouteCode>` to the end of the base URL.

#### Sample Request

https://nnextbus.nus.edu.sg/ActiveBus?route_code=A1

### Sample Response

Showing data for only 1 service as sample.

```
{
    "ActiveBusResult":{
        "TimeStamp":"2025-06-12T16:37:27+08:00",
        "ActiveBusCount":"1",
        "activebus":[
            {
                "vehplate":"PD788A",
                "lat":1.294811,
                "lng":103.770592,
                "speed":0,
                "direction":168.6,
                "loadInfo":{
                    "occupancy":0,
                    "crowdLevel":"low",
                    "capacity":88,"ridership":0
                }
            },
        ]
    }
}
```

## Error Messages from API

401 Unauthorized

- Returns `Unauthorized Access`

404 Not Found

- Returns `Service not found!`

## Credits

Credits to [GitHub User SuibianP Hu Jialun](https://github.com/SuibianP) and his [GitHub repo](https://github.com/SuibianP/nus-nextbus-new-api).
